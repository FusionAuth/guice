<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>XASqlSessionManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">mybatis-guice</a> &gt; <a href="index.source.html" class="el_package">org.mybatis.guice.transactional</a> &gt; <span class="el_source">XASqlSessionManager.java</span></div><h1>XASqlSessionManager.java</h1><pre class="source lang-java linenums">/**
 * Copyright 2009-2017 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
 * an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 */
package org.mybatis.guice.transactional;

import java.lang.reflect.Field;
import java.util.Arrays;
import java.util.IdentityHashMap;
import java.util.concurrent.ConcurrentHashMap;

import javax.transaction.xa.XAException;
import javax.transaction.xa.XAResource;
import javax.transaction.xa.Xid;

import org.apache.ibatis.logging.Log;
import org.apache.ibatis.logging.LogFactory;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionManager;

public class XASqlSessionManager implements XAResource {
<span class="fc" id="L30">  private static final Log log = LogFactory.getLog(XASqlSessionManager.class);</span>

  public static final int NO_TX = 0;
  public static final int STARTED = 1;
  public static final int ENDED = 2;
  public static final int PREPARED = 3;

  private SqlSessionManager sqlSessionManager;
  private int transactionTimeout;
  private String id;
  private Xid xid;
<span class="fc" id="L41">  private int state = NO_TX;</span>

<span class="fc" id="L43">  private static ConcurrentHashMap&lt;GlobalKey, GlobalToken&gt; globalTokens = new ConcurrentHashMap&lt;XASqlSessionManager.GlobalKey, XASqlSessionManager.GlobalToken&gt;();</span>

<span class="fc" id="L45">  public XASqlSessionManager(SqlSessionManager sqlSessionManager) {</span>
<span class="fc" id="L46">    this.sqlSessionManager = sqlSessionManager;</span>
<span class="fc" id="L47">    id = sqlSessionManager.getConfiguration().getEnvironment().getId();</span>
<span class="fc" id="L48">  }</span>

  public String getId() {
<span class="nc" id="L51">    return id;</span>
  }

  public int getState() {
<span class="nc" id="L55">    return state;</span>
  }

  private String xlatedState() {
<span class="nc bnc" id="L59" title="All 5 branches missed.">    switch (state) {</span>
      case NO_TX:
<span class="nc" id="L61">        return &quot;NO_TX&quot;;</span>
      case STARTED:
<span class="nc" id="L63">        return &quot;STARTED&quot;;</span>
      case ENDED:
<span class="nc" id="L65">        return &quot;ENDED&quot;;</span>
      case PREPARED:
<span class="nc" id="L67">        return &quot;PREPARED&quot;;</span>
      default:
<span class="nc" id="L69">        return &quot;!invalid state (&quot; + state + &quot;)!&quot;;</span>
    }
  }

  private String decodeXAResourceFlag(int flag) {
<span class="nc bnc" id="L74" title="All 10 branches missed.">    switch (flag) {</span>
      case XAResource.TMENDRSCAN:
<span class="nc" id="L76">        return &quot;TMENDRSCAN&quot;;</span>
      case XAResource.TMFAIL:
<span class="nc" id="L78">        return &quot;TMFAIL&quot;;</span>
      case XAResource.TMJOIN:
<span class="nc" id="L80">        return &quot;TMJOIN&quot;;</span>
      case XAResource.TMNOFLAGS:
<span class="nc" id="L82">        return &quot;TMNOFLAGS&quot;;</span>
      case XAResource.TMONEPHASE:
<span class="nc" id="L84">        return &quot;TMONEPHASE&quot;;</span>
      case XAResource.TMRESUME:
<span class="nc" id="L86">        return &quot;TMRESUME&quot;;</span>
      case XAResource.TMSTARTRSCAN:
<span class="nc" id="L88">        return &quot;TMSTARTRSCAN&quot;;</span>
      case XAResource.TMSUCCESS:
<span class="nc" id="L90">        return &quot;TMSUCCESS&quot;;</span>
      case XAResource.TMSUSPEND:
<span class="nc" id="L92">        return &quot;TMSUSPEND&quot;;</span>
      default:
<span class="nc" id="L94">        return &quot;&quot; + flag;</span>
    }
  }

  @Override
  public int getTransactionTimeout() throws XAException {
<span class="nc" id="L100">    return transactionTimeout;</span>
  }

  @Override
  public boolean setTransactionTimeout(int second) throws XAException {
<span class="fc" id="L105">    transactionTimeout = second;</span>
<span class="fc" id="L106">    return true;</span>
  }

  @Override
  public void forget(Xid xid) throws XAException {
<span class="nc" id="L111">  }</span>

  @Override
  public Xid[] recover(int flags) throws XAException {
<span class="nc" id="L115">    return new Xid[0];</span>
  }

  @Override
  public boolean isSameRM(XAResource xares) throws XAException {
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">    return this == xares;</span>
  }

  @Override
  public void start(Xid xid, int flag) throws XAException {
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L126">      log.debug(</span>
<span class="nc" id="L127">          id + &quot;: call start old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid + &quot;, flag=&quot; + decodeXAResourceFlag(flag));</span>
    }

<span class="pc bpc" id="L130" title="3 of 4 branches missed.">    if (flag != XAResource.TMNOFLAGS &amp;&amp; flag != XAResource.TMJOIN) {</span>
<span class="nc" id="L131">      throw new MyBatisXAException(id + &quot;: unsupported start flag &quot; + decodeXAResourceFlag(flag),</span>
          XAException.XAER_RMERR);
    }

<span class="pc bpc" id="L135" title="1 of 2 branches missed.">    if (xid == null) {</span>
<span class="nc" id="L136">      throw new MyBatisXAException(id + &quot;: XID cannot be null&quot;, XAException.XAER_INVAL);</span>
    }

<span class="pc bpc" id="L139" title="1 of 2 branches missed.">    if (state == NO_TX) {</span>
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">      if (this.xid != null) {</span>
<span class="nc" id="L141">        throw new MyBatisXAException(id + &quot;: resource already started on XID &quot; + this.xid, XAException.XAER_PROTO);</span>
      } else {
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">        if (flag == XAResource.TMJOIN) {</span>
<span class="nc" id="L144">          throw new MyBatisXAException(id + &quot;: resource not yet started&quot;, XAException.XAER_PROTO);</span>
        } else {
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">          if (log.isDebugEnabled()) {</span>
<span class="nc" id="L147">            log.debug(id + &quot;: OK to start, old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid + &quot;, flag=&quot;</span>
<span class="nc" id="L148">                + decodeXAResourceFlag(flag));</span>
          }
<span class="fc" id="L150">          this.xid = xid;</span>
        }
      }
<span class="nc bnc" id="L153" title="All 2 branches missed.">    } else if (state == STARTED) {</span>
<span class="nc" id="L154">      throw new MyBatisXAException(id + &quot;: resource already started on XID &quot; + this.xid, XAException.XAER_PROTO);</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">    } else if (state == ENDED) {</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">      if (flag == XAResource.TMNOFLAGS) {</span>
<span class="nc" id="L157">        throw new MyBatisXAException(id + &quot;: resource already registered XID &quot; + this.xid, XAException.XAER_DUPID);</span>
      } else {
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (xid.equals(this.xid)) {</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">          if (log.isDebugEnabled()) {</span>
<span class="nc" id="L161">            log.debug(id + &quot;: OK to join, old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid + &quot;, flag=&quot;</span>
<span class="nc" id="L162">                + decodeXAResourceFlag(flag));</span>
          }
        } else {
<span class="nc" id="L165">          throw new MyBatisXAException(id + &quot;: resource already started on XID &quot; + this.xid</span>
              + &quot; - cannot start it on more than one XID at a time&quot;, XAException.XAER_RMERR);
        }
      }
<span class="nc bnc" id="L169" title="All 2 branches missed.">    } else if (state == PREPARED) {</span>
<span class="nc" id="L170">      throw new MyBatisXAException(id + &quot;: resource already prepared on XID &quot; + this.xid, XAException.XAER_PROTO);</span>
    }

<span class="fc" id="L173">    state = STARTED;</span>
<span class="fc" id="L174">    parentSuspend(xid);</span>
<span class="fc" id="L175">  }</span>

  @Override
  public void end(Xid xid, int flag) throws XAException {
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L180">      log.debug(</span>
<span class="nc" id="L181">          id + &quot;: call end old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid + &quot; and flag &quot; + decodeXAResourceFlag(flag));</span>
    }

<span class="pc bpc" id="L184" title="1 of 4 branches missed.">    if (flag != XAResource.TMSUCCESS &amp;&amp; flag != XAResource.TMFAIL) {</span>
<span class="nc" id="L185">      throw new MyBatisXAException(id + &quot;: unsupported end flag &quot; + decodeXAResourceFlag(flag), XAException.XAER_RMERR);</span>
    }

<span class="pc bpc" id="L188" title="1 of 2 branches missed.">    if (xid == null) {</span>
<span class="nc" id="L189">      throw new MyBatisXAException(id + &quot;: XID cannot be null&quot;, XAException.XAER_INVAL);</span>
    }

<span class="pc bpc" id="L192" title="1 of 2 branches missed.">    if (state == NO_TX) {</span>
<span class="nc" id="L193">      throw new MyBatisXAException(id + &quot;: resource never started on XID &quot; + xid, XAException.XAER_PROTO);</span>
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">    } else if (state == STARTED) {</span>
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">      if (this.xid.equals(xid)) {</span>
<span class="pc bpc" id="L196" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L197">          log.debug(</span>
<span class="nc" id="L198">              id + &quot;: OK to end, old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid + &quot;, flag=&quot; + decodeXAResourceFlag(flag));</span>
        }
      } else {
<span class="nc" id="L201">        throw new MyBatisXAException(</span>
            id + &quot;: resource already started on XID &quot; + this.xid + &quot; - cannot end it on another XID &quot; + xid,
            XAException.XAER_PROTO);
      }
<span class="nc bnc" id="L205" title="All 2 branches missed.">    } else if (state == ENDED) {</span>
<span class="nc" id="L206">      throw new MyBatisXAException(id + &quot;: resource already ended on XID &quot; + xid, XAException.XAER_PROTO);</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">    } else if (state == PREPARED) {</span>
<span class="nc" id="L208">      throw new MyBatisXAException(id + &quot;: cannot end, resource already prepared on XID &quot; + xid,</span>
          XAException.XAER_PROTO);
    }

<span class="fc bfc" id="L212" title="All 2 branches covered.">    if (flag == XAResource.TMFAIL) {</span>
      // Rollback transaction. After call method end() call method rollback()
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">      if (log.isDebugEnabled()) {</span>
<span class="nc" id="L215">        log.debug(id + &quot;: after end TMFAIL reset state to ENDED and roolback&quot;);</span>
      }
    }

<span class="fc" id="L219">    this.state = ENDED;</span>
<span class="fc" id="L220">  }</span>

  @Override
  public int prepare(Xid xid) throws XAException {
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L225">      log.debug(id + &quot;: call prepare old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid);</span>
    }

<span class="pc bpc" id="L228" title="1 of 2 branches missed.">    if (xid == null) {</span>
<span class="nc" id="L229">      throw new MyBatisXAException(id + &quot;: XID cannot be null&quot;, XAException.XAER_INVAL);</span>
    }

<span class="pc bpc" id="L232" title="1 of 2 branches missed.">    if (state == NO_TX) {</span>
<span class="nc" id="L233">      throw new MyBatisXAException(id + &quot;: resource never started on XID &quot; + xid, XAException.XAER_PROTO);</span>
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">    } else if (state == STARTED) {</span>
<span class="nc" id="L235">      throw new MyBatisXAException(id + &quot;: resource never ended on XID &quot; + xid, XAException.XAER_PROTO);</span>
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">    } else if (state == ENDED) {</span>
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">      if (this.xid.equals(xid)) {</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L239">          log.debug(id + &quot;: OK to prepare, old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid);</span>
        }
      } else {
<span class="nc" id="L242">        throw new MyBatisXAException(</span>
            id + &quot;: resource already started on XID &quot; + this.xid + &quot; - cannot prepare it on another XID &quot; + xid,
            XAException.XAER_PROTO);
      }
<span class="nc bnc" id="L246" title="All 2 branches missed.">    } else if (state == PREPARED) {</span>
<span class="nc" id="L247">      throw new MyBatisXAException(id + &quot;: resource already prepared on XID &quot; + this.xid, XAException.XAER_PROTO);</span>
    }

<span class="fc" id="L250">    this.state = PREPARED;</span>
<span class="fc" id="L251">    return XAResource.XA_OK;</span>
  }

  @Override
  public void commit(Xid xid, boolean onePhase) throws XAException {
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L257">      log.debug(id + &quot;: call commit old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid + &quot; onePhase is &quot; + onePhase);</span>
    }

<span class="pc bpc" id="L260" title="1 of 2 branches missed.">    if (xid == null) {</span>
<span class="nc" id="L261">      throw new MyBatisXAException(id + &quot;: XID cannot be null&quot;, XAException.XAER_INVAL);</span>
    }

<span class="pc bpc" id="L264" title="1 of 2 branches missed.">    if (state == NO_TX) {</span>
<span class="nc" id="L265">      throw new MyBatisXAException(id + &quot;: resource never started on XID &quot; + xid, XAException.XAER_PROTO);</span>
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">    } else if (state == STARTED) {</span>
<span class="nc" id="L267">      throw new MyBatisXAException(id + &quot;: resource never ended on XID &quot; + xid, XAException.XAER_PROTO);</span>
<span class="pc bpc" id="L268" title="1 of 2 branches missed.">    } else if (state == ENDED) {</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">      if (onePhase) {</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L271">          log.debug(id + &quot;: OK to commit with 1PC, old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid);</span>
        }
      } else {
<span class="nc" id="L274">        throw new MyBatisXAException(id + &quot;: resource never prepared on XID &quot; + xid, XAException.XAER_PROTO);</span>
      }
<span class="pc bpc" id="L276" title="1 of 2 branches missed.">    } else if (state == PREPARED) {</span>
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">      if (!onePhase) {</span>
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">        if (this.xid.equals(xid)) {</span>
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">          if (log.isDebugEnabled()) {</span>
<span class="nc" id="L280">            log.debug(id + &quot;: OK to commit, old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid);</span>
          }
        } else {
<span class="nc" id="L283">          throw new MyBatisXAException(</span>
              id + &quot;: resource already started on XID &quot; + this.xid + &quot; - cannot commit it on another XID &quot; + xid,
              XAException.XAER_PROTO);
        }
      } else {
<span class="nc" id="L288">        throw new MyBatisXAException(id + &quot;: cannot commit in one phase as resource has been prepared on XID &quot; + xid,</span>
            XAException.XAER_PROTO);
      }
    }

    try {
<span class="fc" id="L294">      parentResume(xid);</span>
    } finally {
<span class="pc bpc" id="L296" title="3 of 4 branches missed.">      if (log.isDebugEnabled()) {</span>
<span class="nc" id="L297">        log.debug(id + &quot;: after commit reset state to NO_TX&quot;);</span>
      }
<span class="pc" id="L299">      this.state = NO_TX;</span>
<span class="pc" id="L300">      this.xid = null;</span>
<span class="fc" id="L301">    }</span>
<span class="fc" id="L302">  }</span>

  @Override
  public void rollback(Xid xid) throws XAException {
<span class="pc bpc" id="L306" title="1 of 2 branches missed.">    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L307">      log.debug(id + &quot;: call roolback old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid);</span>
    }

<span class="pc bpc" id="L310" title="1 of 2 branches missed.">    if (xid == null) {</span>
<span class="nc" id="L311">      throw new MyBatisXAException(id + &quot;: XID cannot be null&quot;, XAException.XAER_INVAL);</span>
    }

<span class="pc bpc" id="L314" title="1 of 2 branches missed.">    if (state == NO_TX) {</span>
<span class="nc" id="L315">      throw new MyBatisXAException(id + &quot;: resource never started on XID &quot; + xid, XAException.XAER_PROTO);</span>
<span class="pc bpc" id="L316" title="1 of 2 branches missed.">    } else if (state == STARTED) {</span>
<span class="nc" id="L317">      throw new MyBatisXAException(id + &quot;: resource never ended on XID &quot; + xid, XAException.XAER_PROTO);</span>
<span class="pc bpc" id="L318" title="1 of 2 branches missed.">    } else if (state == ENDED) {</span>
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">      if (this.xid.equals(xid)) {</span>
<span class="pc bpc" id="L320" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L321">          log.debug(id + &quot;: OK to rollback, old state=&quot; + xlatedState() + &quot;, XID=&quot; + xid);</span>
        }
      } else {
<span class="nc" id="L324">        throw new MyBatisXAException(</span>
            id + &quot;: resource already started on XID &quot; + this.xid + &quot; - cannot roll it back on another XID &quot; + xid,
            XAException.XAER_PROTO);
      }
<span class="nc bnc" id="L328" title="All 2 branches missed.">    } else if (state == PREPARED) {</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">      if (log.isDebugEnabled()) {</span>
<span class="nc" id="L330">        log.debug(id + &quot;: rollback reset state from PREPARED to NO_TX&quot;);</span>
      }
<span class="nc" id="L332">      this.state = NO_TX;</span>
<span class="nc" id="L333">      throw new MyBatisXAException(id + &quot;: resource committed during prepare on XID &quot; + this.xid,</span>
          XAException.XA_HEURCOM);
    }

    try {
<span class="fc" id="L338">      parentResume(xid);</span>
    } finally {
<span class="pc bpc" id="L340" title="3 of 4 branches missed.">      if (log.isDebugEnabled()) {</span>
<span class="nc" id="L341">        log.debug(id + &quot;: after rollback reset state to NO_TX&quot;);</span>
      }
<span class="pc" id="L343">      this.state = NO_TX;</span>
<span class="pc" id="L344">      this.xid = null;</span>
<span class="fc" id="L345">    }</span>
<span class="fc" id="L346">  }</span>

  private void parentSuspend(Xid xid) {
<span class="pc bpc" id="L349" title="1 of 2 branches missed.">    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L350">      log.debug(id + &quot;: suspend parent session &quot; + xid);</span>
    }

<span class="fc" id="L353">    byte[] trId = xid.getGlobalTransactionId();</span>
<span class="fc" id="L354">    GlobalKey key = new GlobalKey(trId);</span>
<span class="fc" id="L355">    GlobalToken globalToken = globalTokens.get(key);</span>

<span class="fc bfc" id="L357" title="All 2 branches covered.">    if (globalToken == null) {</span>
<span class="pc bpc" id="L358" title="1 of 2 branches missed.">      if (log.isDebugEnabled()) {</span>
<span class="nc" id="L359">        log.debug(id + &quot;: add GlobalToken &quot; + key);</span>
      }

<span class="fc" id="L362">      globalTokens.put(key, globalToken = new GlobalToken());</span>
    } else {
<span class="pc bpc" id="L364" title="1 of 2 branches missed.">      if (log.isDebugEnabled()) {</span>
<span class="nc" id="L365">        log.debug(id + &quot;: present GlobalToken &quot; + key);</span>
      }
    }
<span class="fc" id="L368">    globalToken.parentSuspend(id, sqlSessionManager);</span>
<span class="fc" id="L369">  }</span>

  private void parentResume(Xid xid) {
<span class="pc bpc" id="L372" title="1 of 2 branches missed.">    if (log.isDebugEnabled()) {</span>
<span class="nc" id="L373">      log.debug(id + &quot;: resume parent session &quot; + xid);</span>
    }

<span class="fc" id="L376">    byte[] trId = xid.getGlobalTransactionId();</span>
<span class="fc" id="L377">    GlobalKey key = new GlobalKey(trId);</span>
<span class="fc" id="L378">    GlobalToken globalToken = globalTokens.get(key);</span>

<span class="pc bpc" id="L380" title="1 of 2 branches missed.">    if (globalToken != null) {</span>
<span class="fc" id="L381">      globalToken.parentResume(id, sqlSessionManager);</span>

<span class="fc bfc" id="L383" title="All 2 branches covered.">      if (globalToken.isEmpty()) {</span>
<span class="pc bpc" id="L384" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L385">          log.debug(id + &quot;: remove GlobalToken &quot; + key);</span>
        }

<span class="fc" id="L388">        globalTokens.remove(key);</span>
      } else {
<span class="pc bpc" id="L390" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L391">          log.debug(id + &quot;: not remove GlobalToken &quot; + key);</span>
        }
      }
    } else {
<span class="nc bnc" id="L395" title="All 2 branches missed.">      if (log.isDebugEnabled()) {</span>
<span class="nc" id="L396">        log.debug(id + &quot;: not find GlobalToken &quot; + key);</span>
      }
    }
<span class="fc" id="L399">  }</span>

  static class GlobalKey {
    final byte[] globalId;
    final int arrayHash;

<span class="fc" id="L405">    public GlobalKey(byte[] globalId) {</span>
<span class="fc" id="L406">      this.globalId = globalId;</span>
<span class="fc" id="L407">      this.arrayHash = Arrays.hashCode(globalId);</span>
<span class="fc" id="L408">    }</span>

    @Override
    public int hashCode() {
<span class="fc" id="L412">      return arrayHash;</span>
    }

    @Override
    public boolean equals(Object obj) {
<span class="pc bpc" id="L417" title="1 of 2 branches missed.">      if (this == obj) {</span>
<span class="nc" id="L418">        return true;</span>
      }

<span class="pc bpc" id="L421" title="1 of 2 branches missed.">      if (obj == null) {</span>
<span class="nc" id="L422">        return false;</span>
      }

<span class="pc bpc" id="L425" title="1 of 2 branches missed.">      if (getClass() != obj.getClass()) {</span>
<span class="nc" id="L426">        return false;</span>
      }

<span class="fc" id="L429">      GlobalKey other = (GlobalKey) obj;</span>
<span class="pc bpc" id="L430" title="1 of 2 branches missed.">      if (!Arrays.equals(globalId, other.globalId)) {</span>
<span class="nc" id="L431">        return false;</span>
      }
<span class="fc" id="L433">      return true;</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L438">      StringBuilder s = new StringBuilder();</span>
<span class="nc" id="L439">      s.append(&quot;[Xid:globalId=&quot;);</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">      for (int i = 0; i &lt; globalId.length; i++) {</span>
<span class="nc" id="L441">        s.append(Integer.toHexString(globalId[i]));</span>
      }
<span class="nc" id="L443">      s.append(&quot;,length=&quot;).append(globalId.length);</span>
<span class="nc" id="L444">      return s.toString();</span>
    }
  }

  static class GlobalToken {
<span class="fc" id="L449">    private final Log log = LogFactory.getLog(getClass());</span>
<span class="fc" id="L450">    IdentityHashMap&lt;SqlSessionManager, Token&gt; tokens = new IdentityHashMap&lt;SqlSessionManager, XASqlSessionManager.Token&gt;();</span>

<span class="fc" id="L452">    public GlobalToken() {</span>
<span class="fc" id="L453">    }</span>

    void parentSuspend(String id, SqlSessionManager sqlSessionManager) {
<span class="fc" id="L456">      Token token = tokens.get(sqlSessionManager);</span>

<span class="fc bfc" id="L458" title="All 2 branches covered.">      if (token == null) {</span>
<span class="pc bpc" id="L459" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L460">          log.debug(id + &quot;: add Token &quot; + sqlSessionManager);</span>
        }

<span class="fc" id="L463">        token = new Token(sqlSessionManager);</span>
<span class="fc" id="L464">        tokens.put(sqlSessionManager, token);</span>
      } else {
<span class="pc bpc" id="L466" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L467">          log.debug(id + &quot;: present Token &quot; + sqlSessionManager);</span>
        }
      }
<span class="fc" id="L470">      token.parentSuspend(id);</span>
<span class="fc" id="L471">    }</span>

    void parentResume(String id, SqlSessionManager sqlSessionManager) {
<span class="fc" id="L474">      Token token = tokens.get(sqlSessionManager);</span>

<span class="pc bpc" id="L476" title="1 of 2 branches missed.">      if (token != null) {</span>
<span class="fc" id="L477">        token.parentResume(id);</span>

        // remove last
<span class="fc bfc" id="L480" title="All 2 branches covered.">        if (token.isFirst()) {</span>
<span class="pc bpc" id="L481" title="1 of 2 branches missed.">          if (log.isDebugEnabled()) {</span>
<span class="nc" id="L482">            log.debug(id + &quot;: remove parent session &quot; + sqlSessionManager);</span>
          }

<span class="fc" id="L485">          tokens.remove(sqlSessionManager);</span>
        }
      } else {
<span class="nc bnc" id="L488" title="All 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L489">          log.debug(id + &quot;: not find parent session &quot; + sqlSessionManager);</span>
        }
      }
<span class="fc" id="L492">    }</span>

    boolean isEmpty() {
<span class="fc" id="L495">      return tokens.isEmpty();</span>
    }
  }

  static class Token {
<span class="fc" id="L500">    private final Log log = LogFactory.getLog(getClass());</span>
    final SqlSessionManager sqlSessionManager;
    ThreadLocal&lt;SqlSession&gt; localSqlSession;
    SqlSession suspendedSqlSession;
    int count;

    @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L507">    public Token(SqlSessionManager sqlSessionManager) {</span>
<span class="fc" id="L508">      this.sqlSessionManager = sqlSessionManager;</span>
<span class="fc" id="L509">      this.count = 0;</span>
      try {
<span class="fc" id="L511">        Field field = SqlSessionManager.class.getDeclaredField(&quot;localSqlSession&quot;);</span>
<span class="fc" id="L512">        field.setAccessible(true);</span>
<span class="fc" id="L513">        localSqlSession = (ThreadLocal&lt;SqlSession&gt;) field.get(sqlSessionManager);</span>
<span class="nc" id="L514">      } catch (Exception e) {</span>
<span class="fc" id="L515">      }</span>
<span class="fc" id="L516">    }</span>

    boolean isFirst() {
<span class="fc bfc" id="L519" title="All 2 branches covered.">      return count == 0;</span>
    }

    void parentSuspend(String id) {
<span class="fc bfc" id="L523" title="All 2 branches covered.">      if (isFirst()) {</span>
<span class="pc bpc" id="L524" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L525">          log.debug(id + &quot; suspend parent session&quot;);</span>
        }

<span class="pc bpc" id="L528" title="1 of 2 branches missed.">        if (localSqlSession != null) {</span>
<span class="fc" id="L529">          suspendedSqlSession = localSqlSession.get();</span>
<span class="fc" id="L530">          localSqlSession.remove();</span>
        }
      } else {
<span class="pc bpc" id="L533" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L534">          log.debug(id + &quot; skip suspend parent session&quot;);</span>
        }
      }
<span class="fc" id="L537">      count++;</span>
<span class="fc" id="L538">    }</span>

    void parentResume(String id) {
<span class="pc bpc" id="L541" title="1 of 2 branches missed.">      if (count &gt; 0) {</span>
<span class="fc" id="L542">        count--;</span>
      }

<span class="fc bfc" id="L545" title="All 2 branches covered.">      if (isFirst()) {</span>
<span class="pc bpc" id="L546" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L547">          log.debug(id + &quot; resume parent session&quot;);</span>
        }

<span class="pc bpc" id="L550" title="1 of 2 branches missed.">        if (localSqlSession != null) {</span>
<span class="fc bfc" id="L551" title="All 2 branches covered.">          if (suspendedSqlSession == null) {</span>
<span class="fc" id="L552">            localSqlSession.remove();</span>
          } else {
<span class="fc" id="L554">            localSqlSession.set(suspendedSqlSession);</span>
<span class="fc" id="L555">            suspendedSqlSession = null;</span>
          }
        }
      } else {
<span class="pc bpc" id="L559" title="1 of 2 branches missed.">        if (log.isDebugEnabled()) {</span>
<span class="nc" id="L560">          log.debug(id + &quot; skip resume parent session&quot;);</span>
        }
      }
<span class="fc" id="L563">    }</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>